-- è¶…å¼ºç½—å¸ƒä¹æ€å¥–åŠ±è¿½è¸ªè„šæœ¬ - ä¼˜åŒ–ç‰ˆ
-- ç¡®ä¿èƒ½åœ¨æ§åˆ¶å°çœ‹åˆ°å¥–åŠ±è§¦å‘ä»£ç 

local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local localPlayer = Players.LocalPlayer

-- é…ç½®åŒºåŸŸ - ä¼˜åŒ–é…ç½®
local config = {
    logToFile = false, -- å…ˆå…³é—­æ–‡ä»¶è®°å½•ï¼Œä¸“æ³¨æ§åˆ¶å°è¾“å‡º
    logFileName = "reward_tracker.log",
    learningMode = true, -- å¼€å¯å­¦ä¹ æ¨¡å¼å‘ç°æ‰€æœ‰äº‹ä»¶
    showCallStack = true, -- æ˜¾ç¤ºè°ƒç”¨å †æ ˆå®šä½ä»£ç 
    captureAllRemotes = true, -- æ•è·æ‰€æœ‰è¿œç¨‹äº‹ä»¶è¿›è¡Œå­¦ä¹ 
    highlightRewards = true,
    simpleOutput = true -- ç®€åŒ–è¾“å‡ºæ ¼å¼
}

-- ç™½åå•ï¼ˆå­¦ä¹ æ¨¡å¼ä¼šè‡ªåŠ¨å‘ç°å¹¶æ·»åŠ ï¼‰
local whitelist = {
    "RewardEvent", "Reward", "GetReward", "ClaimReward",
    "Award", "Prize", "Loot", "Drop", "Gift", "Bonus",
    "variableserver", "Lab", "Event", "RequestLuckyTool", 
    "TsunamiUIEvent", "DailyReward", "QuestReward", "MissionReward",
    "LevelUp", "Achievement", "Collect", "OpenChest", "SpinWheel",
    "Currency", "Coins", "Gems", "Money", "EXP", "Experience"
}

-- å·²å‘ç°çš„è¿œç¨‹äº‹ä»¶
local discoveredEvents = {}

-- å¢å¼ºæ—¥å¿—å‡½æ•° - ç¡®ä¿æ§åˆ¶å°è¾“å‡º
local function logMessage(message, isReward)
    local timestamp = os.date("%H:%M:%S")
    local formattedMessage = ""
    
    if config.simpleOutput then
        -- ç®€åŒ–è¾“å‡ºæ ¼å¼
        if isReward then
            formattedMessage = string.format("ğŸ [%s] å¥–åŠ±äº‹ä»¶: %s", timestamp, message)
            -- åœ¨æ”¯æŒé¢œè‰²çš„ç¯å¢ƒä¸­ä½¿ç”¨é†’ç›®æ ‡è®°
            if rconsoleprint then
                rconsoleprint("@@LIGHT_RED@@")
                rconsoleprint(formattedMessage)
                rconsoleprint("@@WHITE@@\n")
            else
                print(formattedMessage)
            end
        else
            formattedMessage = string.format("[%s] %s", timestamp, message)
            print(formattedMessage)
        end
    else
        -- å®Œæ•´è¾“å‡ºæ ¼å¼
        local prefix = isReward and "ğŸ [å¥–åŠ±äº‹ä»¶] " or "[è¿œç¨‹ç›‘æ§] "
        formattedMessage = string.format("[%s]%s %s", timestamp, prefix, message)
        print(formattedMessage)
    end
    
    -- æ–‡ä»¶è®°å½•ï¼ˆå¯é€‰ï¼‰
    if config.logToFile and writefile then
        pcall(function()
            if not isfile(config.logFileName) then
                writefile(config.logFileName, "å¥–åŠ±è¿½è¸ªæ—¥å¿—\nåˆ›å»ºæ—¶é—´: " .. os.date() .. "\n\n")
            end
            appendfile(config.logFileName, formattedMessage .. "\n")
        end)
    end
end

-- è·å–è°ƒç”¨å †æ ˆ - å®šä½è§¦å‘ä»£ç çš„å…³é”®
local function getCallStack()
    if not config.showCallStack then
        return ""
    end
    
    local stack = "\nè°ƒç”¨å †æ ˆ:"
    local foundScript = false
    
    for i = 3, 15 do -- å¢åŠ æ·±åº¦ä»¥æ‰¾åˆ°æ›´å¤šç›¸å…³ä¿¡æ¯
        local info = debug.info(i, "sl")
        if not info or not info.source then break end
        
        local source = string.gsub(info.source, "^@", "")
        local line = info.currentline > 0 and info.currentline or "?"
        
        -- è¿‡æ»¤æ‰ç³»ç»Ÿè„šæœ¬ï¼Œä¸“æ³¨äºæ¸¸æˆè„šæœ¬
        if not string.find(source, "CoreScript") and 
           not string.find(source, "CoreGui") and
           not string.find(source, "Promise") then
            
            -- é«˜äº®æ˜¾ç¤ºå¯èƒ½çš„æ¸¸æˆè„šæœ¬
            local isGameScript = string.find(source, "Workspace") or 
                               string.find(source, "PlayerScripts") or
                               string.find(source, "ReplicatedFirst") or
                               string.find(source, "ReplicatedStorage") or
                               string.find(source, "ServerStorage") or
                               string.find(source, "Lighting")
            
            if isGameScript then
                stack = stack .. string.format("\n%s:%s", source, line)
                foundScript = true
            else
                stack = stack .. string.format("\n   %s:%s", source, line)
            end
        end
    end
    
    if not foundScript then
        stack = stack .. "\n   (æœªæ‰¾åˆ°æ˜ç¡®çš„æ¸¸æˆè„šæœ¬ä½ç½®)"
    end
    
    return stack
end

-- å‚æ•°ç¾åŒ–å‡½æ•° - ä¼˜åŒ–æ˜¾ç¤º
local function prettyArgs(args, depth)
    depth = depth or 0
    if depth > 2 then return "..." end
    
    local out = {}
    
    for i, v in ipairs(args) do
        local vType = typeof(v)
        
        if vType == "table" then
            if next(v) == nil then
                table.insert(out, "{}")
            else
                table.insert(out, "table[...]")
            end
        elseif vType == "Instance" then
            local name = pcall(function() return v.Name end) and v.Name or "Unknown"
            local class = pcall(function() return v.ClassName end) and v.ClassName or "Unknown"
            table.insert(out, string.format("%s[%s]", name, class))
        elseif vType == "Vector3" then
            table.insert(out, string.format("Vector3(%.0f,%.0f,%.0f)", v.X, v.Y, v.Z))
        elseif vType == "CFrame" then
            table.insert(out, "CFrame")
        elseif vType == "number" then
            table.insert(out, tostring(v))
        elseif vType == "string" then
            if #v > 50 then
                table.insert(out, string.format("%q...", v:sub(1, 47)))
            else
                table.insert(out, string.format("%q", v))
            end
        else
            table.insert(out, tostring(v))
        end
    end
    
    return table.concat(out, ", ")
end

-- æ£€æµ‹å¥–åŠ±äº‹ä»¶ - å¢å¼ºæ£€æµ‹é€»è¾‘
local function isRewardEvent(eventName, args)
    local nameLower = eventName:lower()
    
    -- å¥–åŠ±å…³é”®è¯æ£€æµ‹
    local rewardKeywords = {
        "reward", "prize", "award", "loot", "drop", "gift", "bonus",
        "collect", "chest", "wheel", "daily", "quest", "mission",
        "achievement", "levelup", "level", "win", "victory", "complete",
        "coin", "gem", "money", "cash", "currency", "point", "exp", "experience",
        "token", "crystal", "diamond", "gold", "silver", "bronze"
    }
    
    for _, keyword in ipairs(rewardKeywords) do
        if string.find(nameLower, keyword) then
            return true
        end
    end
    
    -- å‚æ•°å†…å®¹æ£€æµ‹
    local argsStr = HttpService:JSONEncode(args):lower()
    local valueIndicators = {
        "amount", "value", "count", "quantity", "points", "exp", "xp",
        "coin", "gem", "money", "cash", "reward", "prize"
    }
    
    for _, indicator in ipairs(valueIndicators) do
        if string.find(argsStr, indicator) then
            return true
        end
    end
    
    return false
end

-- åˆå§‹åŒ–äº‹ä»¶åˆ—è¡¨
for _, event in ipairs(whitelist) do
    discoveredEvents[event] = true
end

-- ä¸»Hooké€»è¾‘ - ç¡®ä¿èƒ½æ•è·æ‰€æœ‰ç›¸å…³äº‹ä»¶
local function setupHooks()
    -- æ£€æŸ¥ç¯å¢ƒå…¼å®¹æ€§
    if not getrawmetatable or not getnamecallmethod then
        logMessage("å½“å‰ç¯å¢ƒä¸æ”¯æŒå…ƒè¡¨Hookï¼Œè„šæœ¬æ— æ³•è¿è¡Œ", false)
        return false
    end
    
    local mt = getrawmetatable(game)
    if not mt then
        logMessage("æ— æ³•è·å–æ¸¸æˆå…ƒè¡¨", false)
        return false
    end
    
    local oldNamecall = mt.__namecall
    if not oldNamecall then
        logMessage("å…ƒè¡¨ç¼ºå°‘__namecallæ–¹æ³•", false)
        return false
    end
    
    setreadonly(mt, false)
    
    -- ä¸»Hookå‡½æ•°
    mt.__namecall = function(self, ...)
        local method = getnamecallmethod()
        local success, name = pcall(function() return self.Name end)
        local args = {...}
        
        if success and name and (method == "FireServer" or method == "InvokeServer") then
            local shouldLog = config.captureAllRemotes or 
                             discoveredEvents[name] or 
                             (config.learningMode and not discoveredEvents[name])
            
            if shouldLog then
                -- å­¦ä¹ æ¨¡å¼ï¼šè®°å½•æ–°äº‹ä»¶
                if config.learningMode and not discoveredEvents[name] then
                    discoveredEvents[name] = true
                    logMessage("å‘ç°æ–°è¿œç¨‹äº‹ä»¶: " .. name, false)
                end
                
                -- åˆ¤æ–­å¥–åŠ±äº‹ä»¶
                local isReward = config.highlightRewards and isRewardEvent(name, args)
                
                -- å‡†å¤‡è¾“å‡ºä¿¡æ¯
                local argString = prettyArgs(args)
                local callStack = getCallStack()
                
                if isReward then
                    logMessage(string.format("ğŸš¨ è§¦å‘å¥–åŠ±: %s.%s(%s)%s", name, method, argString, callStack), true)
                else
                    logMessage(string.format("%s.%s(%s)%s", name, method, argString, callStack), false)
                end
            end
        end
        
        return oldNamecall(self, ...)
    end
    
    setreadonly(mt, true)
    return true
end

-- å¯åŠ¨è„šæœ¬
logMessage("å¼€å§‹åˆå§‹åŒ–å¥–åŠ±è¿½è¸ªè„šæœ¬...", false)

local success, err = pcall(function()
    return setupHooks()
end)

if success then
    logMessage("è„šæœ¬åˆå§‹åŒ–æˆåŠŸ! å¼€å§‹ç›‘æ§æ¸¸æˆå¥–åŠ±...", false)
    logMessage("åœ¨æ¸¸æˆä¸­è·å¾—å¥–åŠ±æ—¶ï¼Œä¼šæ˜¾ç¤º ğŸ æˆ– ğŸš¨ æ ‡è®°çš„äº‹ä»¶", false)
    logMessage("å­¦ä¹ æ¨¡å¼å·²å¼€å¯ï¼Œæ­£åœ¨å‘ç°æ‰€æœ‰è¿œç¨‹äº‹ä»¶...", false)
    
    -- æ·»åŠ å®šæœŸçŠ¶æ€æŠ¥å‘Š
    delay(10, function()
        local eventCount = 0
        for _ in pairs(discoveredEvents) do eventCount = eventCount + 1 end
        logMessage(string.format("å·²å‘ç° %d ä¸ªè¿œç¨‹äº‹ä»¶ï¼Œç»§ç»­ç›‘æ§ä¸­...", eventCount), false)
    end)
    
else
    logMessage("è„šæœ¬åˆå§‹åŒ–å¤±è´¥: " .. tostring(err), false)
    logMessage("å»ºè®®: å°è¯•åœ¨å…¶å®ƒæ‰§è¡Œç¯å¢ƒä¸­è¿è¡Œæ­¤è„šæœ¬", false)
end

-- å®ç”¨åŠŸèƒ½
local function showDiscoveredEvents()
    local events = {}
    for name in pairs(discoveredEvents) do
        table.insert(events, name)
    end
    table.sort(events)
    
    logMessage("å·²å‘ç°çš„è¿œç¨‹äº‹ä»¶åˆ—è¡¨:", false)
    for i, event in ipairs(events) do
        logMessage("   " .. i .. ". " .. event, false)
    end
    return events
end

-- è¿”å›æ§åˆ¶æ¥å£
return {
    showEvents = showDiscoveredEvents,
    toggleLearning = function()
        config.learningMode = not config.learningMode
        logMessage("å­¦ä¹ æ¨¡å¼: " .. (config.learningMode and "å¼€å¯" or "å…³é—­"), false)
    end,
    addEvent = function(eventName)
        discoveredEvents[eventName] = true
        logMessage("å·²ç›‘æ§äº‹ä»¶: " .. eventName, false)
    end,
    getStats = function()
        local count = 0
        for _ in pairs(discoveredEvents) do count = count + 1 end
        return {totalEvents = count}
    end
}