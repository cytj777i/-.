-- å¢å¼ºç‰ˆå¥–åŠ±è¿½è¸ªè„šæœ¬ - ä¸“æ³¨äºä¸Šä¸‹æ–‡ä¿¡æ¯æ”¶é›†
local Players = game:GetService("Players")
local localPlayer = Players.LocalPlayer
local RunService = game:GetService("RunService")

-- é…ç½®
local config = {
    enhancedLogging = true, -- å¢å¼ºæ—¥å¿—è®°å½•
    scanRemotesOnStart = true, -- å¯åŠ¨æ—¶æ‰«æè¿œç¨‹å¯¹è±¡
    trackPlayerContext = true -- è¿½è¸ªç©å®¶ä¸Šä¸‹æ–‡
}

-- å­˜å‚¨çŠ¶æ€
local playerState = {
    position = Vector3.new(0, 0, 0),
    health = 100,
    character = nil,
    nearbyObjects = {}
}

-- å¢å¼ºçš„ä¸Šä¸‹æ–‡è®°å½•
local function captureEnvironmentContext()
    local context = {}
    
    -- è®°å½•ç©å®¶åŸºç¡€ä¿¡æ¯
    pcall(function()
        if localPlayer.Character then
            local humanoid = localPlayer.Character:FindFirstChildOfClass("Humanoid")
            local rootPart = localPlayer.Character:FindFirstChild("HumanoidRootPart")
            
            if humanoid then
                playerState.health = humanoid.Health
                context.health = humanoid.Health
            end
            
            if rootPart then
                playerState.position = rootPart.Position
                context.position = {
                    x = math.floor(rootPart.Position.X),
                    y = math.floor(rootPart.Position.Y),
                    z = math.floor(rootPart.Position.Z)
                }
                
                -- è®°å½•é™„è¿‘ç‰©ä½“
                local nearby = {}
                for _, obj in ipairs(workspace:GetChildren()) do
                    if obj:IsA("Part") and obj ~= rootPart then
                        local distance = (rootPart.Position - obj.Position).Magnitude
                        if distance < 30 then
                            table.insert(nearby, {
                                name = obj.Name,
                                distance = math.floor(distance)
                            })
                        end
                    end
                end
                context.nearby = nearby
            end
        end
    end)
    
    -- è®°å½•æ¸¸æˆæ•°æ®
    pcall(function()
        local leaderstats = localPlayer:FindFirstChild("leaderstats")
        if leaderstats then
            context.stats = {}
            for _, stat in ipairs(leaderstats:GetChildren()) do
                if stat:IsA("IntValue") or stat:IsA("NumberValue") then
                    context.stats[stat.Name] = stat.Value
                end
            end
        end
    end)
    
    return context
end

-- å¢å¼ºçš„å¥–åŠ±æ—¥å¿—è®°å½•
local function logEnhancedReward(eventName, method, args)
    local context = captureEnvironmentContext()
    
    print("\nğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ")
    print("ğŸ å¥–åŠ±äº‹ä»¶è§¦å‘!")
    print("ğŸ äº‹ä»¶: " .. eventName .. "." .. method)
    print("ğŸ å‚æ•°: " .. tostring(args and #args or 0) .. " ä¸ªå‚æ•°")
    
    if args then
        for i, arg in ipairs(args) do
            local argType = typeof(arg)
            print("   ğŸ“Œ å‚æ•° " .. i .. ": [" .. argType .. "] " .. tostring(arg))
        end
    end
    
    -- æ˜¾ç¤ºç¯å¢ƒä¸Šä¸‹æ–‡
    print("ğŸ ç¯å¢ƒä¸Šä¸‹æ–‡:")
    if context.position then
        print("   ğŸ“ ä½ç½®: X=" .. context.position.x .. ", Y=" .. context.position.y .. ", Z=" .. context.position.z)
    end
    
    if context.health then
        print("   â¤ï¸ ç”Ÿå‘½å€¼: " .. context.health)
    end
    
    if context.stats then
        print("   ğŸ“Š æ¸¸æˆæ•°æ®:")
        for statName, value in pairs(context.stats) do
            print("      " .. statName .. ": " .. tostring(value))
        end
    end
    
    if context.nearby and #context.nearby > 0 then
        print("   ğŸ·ï¸ é™„è¿‘ç‰©ä½“:")
        for i, obj in ipairs(context.nearby) do
            if i <= 5 then -- é™åˆ¶æ˜¾ç¤ºæ•°é‡
                print("      - " .. obj.name .. " (" .. obj.distance .. " ç±³)")
            end
        end
        if #context.nearby > 5 then
            print("      ... è¿˜æœ‰ " .. (#context.nearby - 5) .. " ä¸ªç‰©ä½“")
        end
    end
    
    print("ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ\n")
end

-- ä¸»åŠ¨æ‰«æè¿œç¨‹å¯¹è±¡
local function scanRemoteObjects()
    print("ğŸ” å¼€å§‹æ‰«ææ¸¸æˆä¸­çš„è¿œç¨‹å¯¹è±¡...")
    
    local remoteLocations = {
        game:GetService("ReplicatedStorage"),
        workspace,
        game:GetService("ServerScriptService"),
        game:GetService("ServerStorage"),
        game:GetService("StarterPlayer"):FindFirstChild("StarterPlayerScripts"),
        game:GetService("StarterPlayer"):FindFirstChild("StarterCharacterScripts"),
        localPlayer:FindFirstChild("PlayerScripts")
    }
    
    local foundEvents = {}
    local foundFunctions = {}
    
    for _, location in ipairs(remoteLocations) do
        if location then
            pcall(function()
                for _, child in ipairs(location:GetDescendants()) do
                    if child:IsA("RemoteEvent") then
                        foundEvents[child.Name] = true
                    elseif child:IsA("RemoteFunction") then
                        foundFunctions[child.Name] = true
                    end
                end
            end)
        end
    end
    
    -- è¾“å‡ºæ‰«æç»“æœ
    local eventNames = {}
    for name in pairs(foundEvents) do
        table.insert(eventNames, name)
    end
    
    local functionNames = {}
    for name in pairs(foundFunctions) do
        table.insert(functionNames, name)
    end
    
    table.sort(eventNames)
    table.sort(functionNames)
    
    print("ğŸ“‹ æ‰«æç»“æœ:")
    print("   RemoteEvents: " .. #eventNames .. " ä¸ª")
    for i, name in ipairs(eventNames) do
        print("   - " .. name)
    end
    
    print("   RemoteFunctions: " .. #functionNames .. " ä¸ª")
    for i, name in ipairs(functionNames) do
        print("   - " .. name)
    end
    
    return {
        events = foundEvents,
        functions = foundFunctions
    }
end

-- è®¾ç½®ç›‘æ§
local function setupMonitoring()
    local scannedRemotes = scanRemoteObjects()
    
    local mt = getrawmetatable(game)
    local oldNamecall = mt.__namecall
    
    setreadonly(mt, false)
    
    mt.__namecall = function(self, ...)
        local method = getnamecallmethod()
        local args = {...}
        
        if method == "FireServer" or method == "InvokeServer" then
            local success, name = pcall(function() return self.Name end)
            
            if success and name then
                -- è®°å½•æ‰€æœ‰è¿œç¨‹è°ƒç”¨ï¼ˆæˆ–è€…åªè®°å½•å¥–åŠ±ç›¸å…³çš„ï¼‰
                local isRewardRelated = string.lower(name):find("reward") or 
                                      string.lower(name):find("claim") or
                                      string.lower(name):find("award") or
                                      string.lower(name):find("prize")
                
                if isRewardRelated then
                    logEnhancedReward(name, method, args)
                else
                    -- å¯é€‰ï¼šè®°å½•æ‰€æœ‰è¿œç¨‹è°ƒç”¨ç”¨äºåˆ†æ
                    -- print("[ç›‘æ§] " .. name .. "." .. method)
                end
            end
        end
        
        return oldNamecall(self, ...)
    end
    
    setreadonly(mt, true)
    
    print("âœ… å¢å¼ºç›‘æ§å·²å¯åŠ¨!")
    print("ğŸ’¡ æ­£åœ¨è¿½è¸ªå¥–åŠ±äº‹ä»¶å’Œç¯å¢ƒä¸Šä¸‹æ–‡...")
end

-- å¯åŠ¨è„šæœ¬
if config.scanRemotesOnStart then
    delay(2, function()
        setupMonitoring()
    end)
end

return {
    rescan = scanRemoteObjects,
    getConfig = function() return config end
}